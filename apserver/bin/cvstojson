#!/usr/bin/env bash

set -euo pipefail

function cvstojson() {
  local cwd="$1"
  csv_path="$cwd/qanda.csv"
  json_path="$cwd/qanda.json"

  # ヘッダー行の読み込み
  header_line=$(head -n 1 "$csv_path")
  # ヘッダー行から列名を取得
  columns=()
  for col in $(echo "$header_line" | tr ',' ' '); do
    columns+=("$col")
  done

  # JSONファイルの生成
  echo "[" >"$json_path"

  # CSVファイルの各行を処理
  row_num=0
  skip_first_row_flag=0
  while IFS=, read -r category question answer source; do
    # 最初の行はヘッダーなので,skip_first_row_flagをfalseにしてスキップ
    if [ $skip_first_row_flag -eq 0 ]; then
      skip_first_row_flag=1
      continue
    fi

    # 行番号のインクリメント
    row_num=$((row_num + 1))

    # JSONオブジェクトの生成
    json_object="{
      \"model\": \"app.ghostintheshell\",
      \"pk\": $row_num,
      \"fields\": {
        \"category\": \"$category\",
        \"question\": \"$question\",
        \"answer\": \"$answer\"
      }
    }"

    if [ $row_num -eq 1 ]; then
      echo "$json_object" >>"$json_path"
    else
      echo ",$json_object" >>"$json_path"
    fi
  done <"$csv_path"

  # JSONファイルの終了
  echo "]" >>"$json_path"
}

function main() {
  local cwd
  cwd="$(cd "$(dirname "$0")" && pwd)"
  cvstojson "${cwd}"
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  main "$@"
fi
